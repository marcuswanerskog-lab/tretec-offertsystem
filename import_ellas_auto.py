#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Tretec Larm - Auto-uppdatera product_database.js med ellÃ¥s
"""

import json
import re
import os
from datetime import datetime

print("=" * 60)
print("AUTO-UPPDATERA PRODUCT_DATABASE.JS MED ELLÃ…S")
print("=" * 60)
print()

# 1. LÃ¤s ellÃ¥s-produkterna
print("ğŸ“¦ LÃ¤ser ellÃ¥s-produkter frÃ¥n lasgiganten_ellas_all.json...")
with open('lasgiganten_ellas_all.json', 'r', encoding='utf-8') as f:
    products = json.load(f)

print(f"âœ… Hittade {len(products)} produkter")
print()

# 2. Konvertera till rÃ¤tt format
print("ğŸ”„ Konverterar till Tretec-format...")
ellas_products = []

for product in products:
    ellas_product = {
        "artikelnummer": product.get('sku', ''),
        "e_nummer": "",
        "benamning": product.get('name', ''),
        "lagsta_orderantal": None,
        "rabattgrupp": "E",
        "pris": product.get('price', 0),
        "supplier": product.get('supplier', 'LÃ¥sgiganten'),
        "url": product.get('url', '')
    }
    ellas_products.append(ellas_product)

print(f"âœ… Konverterade {len(ellas_products)} produkter")
print()

# 3. Kolla om product_database.js finns
if os.path.exists('product_database.js'):
    print("ğŸ“„ Hittar product_database.js - lÃ¤ser befintlig databas...")
    
    with open('product_database.js', 'r', encoding='utf-8') as f:
        content = f.read()
    
    # Hitta PRODUCT_DB-objektet
    match = re.search(r'const PRODUCT_DB\s*=\s*({[\s\S]*?});', content)
    
    if match:
        # Parsa befintlig databas
        db_json = match.group(1)
        try:
            existing_db = json.loads(db_json)
            print(f"âœ… Befintlig databas inlÃ¤st")
            print(f"   - LÃ¤sare: {len(existing_db.get('lasare', []))} produkter")
            print(f"   - Centralapparater: {len(existing_db.get('centralapparater', []))} produkter")
            print(f"   - TillbehÃ¶r: {len(existing_db.get('tillbehor', []))} produkter")
            print(f"   - EllÃ¥s (gamla): {len(existing_db.get('ellas', []))} produkter")
            print()
            
            # Uppdatera ellÃ¥s
            existing_db['ellas'] = ellas_products
            
            print(f"ğŸ”„ Uppdaterar ellÃ¥s-kategorin...")
            print(f"   - EllÃ¥s (nya): {len(existing_db['ellas'])} produkter")
            print()
            
            # Skapa backup
            backup_file = f'product_database_backup_{datetime.now().strftime("%Y%m%d_%H%M%S")}.js'
            print(f"ğŸ’¾ Skapar backup: {backup_file}")
            with open(backup_file, 'w', encoding='utf-8') as f:
                f.write(content)
            print("âœ… Backup skapad")
            print()
            
            # Skriv uppdaterad databas
            new_content = f"""// Product Database - Updated {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
// Auto-generated by import_ellas_auto.py
const PRODUCT_DB = {json.dumps(existing_db, ensure_ascii=False, indent=2)};
"""
            
            with open('product_database.js', 'w', encoding='utf-8') as f:
                f.write(new_content)
            
            print("âœ… product_database.js uppdaterad!")
            print()
            
        except json.JSONDecodeError as e:
            print(f"âŒ Kunde inte parsa befintlig databas: {e}")
            print("ğŸ’¡ Skapar en helt ny product_database.js istÃ¤llet...")
            create_new = True
    else:
        print("âš ï¸ Kunde inte hitta PRODUCT_DB i filen")
        print("ğŸ’¡ Skapar en helt ny product_database.js istÃ¤llet...")
        create_new = True
else:
    print("âš ï¸ product_database.js finns inte")
    print("ğŸ’¡ Skapar en helt ny product_database.js...")
    create_new = True

# 4. Skapa ny databas om behÃ¶vs
if 'create_new' in locals() and create_new:
    new_db = {
        "lasare": [],
        "centralapparater": [],
        "tillbehor": [],
        "ellas": ellas_products
    }
    
    new_content = f"""// Product Database - Created {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
// Generated by import_ellas_auto.py
const PRODUCT_DB = {json.dumps(new_db, ensure_ascii=False, indent=2)};
"""
    
    with open('product_database.js', 'w', encoding='utf-8') as f:
        f.write(new_content)
    
    print("âœ… Ny product_database.js skapad med ellÃ¥s-produkter!")
    print()

# 5. Statistik
print("=" * 60)
print("ğŸ“Š SAMMANFATTNING")
print("=" * 60)
prices = [p['pris'] for p in ellas_products if p['pris']]
print(f"Antal ellÃ¥s-produkter: {len(ellas_products)}")
print(f"LÃ¤gsta pris: {min(prices):.2f} kr")
print(f"HÃ¶gsta pris: {max(prices):.2f} kr")
print(f"Medelpris: {sum(prices)/len(prices):.2f} kr")
print()

print("=" * 60)
print("ğŸ‰ KLART!")
print("=" * 60)
print()
print("NÃ¤sta steg:")
print("1. Starta om servern (Ctrl+C och python server_v3.py)")
print("2. Ã–ppna systemet: http://localhost:5000")
print("3. GÃ¥ till Produkter-vyn")
print("4. Filtrera pÃ¥ kategori: EllÃ¥s")
print("5. Du ska nu se alla 200 produkter!")
print()
